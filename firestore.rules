rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(wishlistData) {
      return isSignedIn() && wishlistData.owner == request.auth.uid;
    }
    
    function hasRole(wishlistData, role) {
      return isSignedIn() && 
             wishlistData.roles != null && 
             wishlistData.roles[request.auth.uid] == role;
    }
    
    function isMember(wishlistData) {
      return isSignedIn() && 
             wishlistData.members != null && 
             request.auth.uid in wishlistData.members;
    }

    // User profiles
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // Wishlists
    match /wishlists/{wishlistId} {
      // 'get' allows reading a single document (needed for the join page)
      allow get: if isSignedIn(); 
      
      // 'list' allows queries on the collection. 
      // To satisfy 'insufficient permissions', the query MUST match these constraints.
      allow list: if isSignedIn() && (
        // Allow querying by owner
        (request.query.limit <= 100 && request.query.filters.size() > 0) ||
        // fallback for general list if needed
        isMember(resource.data)
      );
      
      allow create: if isSignedIn() && request.resource.data.owner == request.auth.uid;
      
      allow update: if isSignedIn() && (
        isOwner(resource.data) || 
        hasRole(resource.data, 'manager') ||
        (isOwner(resource.data) && request.resource.data.diff(resource.data).affectedKeys().hasAny(['members', 'roles']))
      );
      
      allow delete: if isOwner(resource.data);

      // Items sub-collection
      match /items/{itemId} {
        allow read: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data);
        allow create: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) && 
                      (isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) || 
                       hasRole(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data, 'manager'));
        allow update: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) && (
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['claimed', 'claimedBy', 'claimedAt'])) ||
          (isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) || 
           hasRole(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data, 'manager'))
        );
        allow delete: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) && 
                      (isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) || 
                       hasRole(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data, 'manager'));
      }

      match /requests/{requestId} {
        allow read: if isSignedIn() && (
          request.auth.uid == resource.data.uid || 
          isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data)
        );
        allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
        allow update: if isSignedIn() && isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data);
        allow delete: if isSignedIn() && (
          request.auth.uid == resource.data.uid || 
          isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data)
        );
      }
    }
    
    match /groups/{groupId} {
      allow read: if isSignedIn() && request.auth.uid in resource.data.members;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.owner == request.auth.uid;
    }
  }
}
