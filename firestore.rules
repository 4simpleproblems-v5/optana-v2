rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(wishlistData) {
      return isSignedIn() && wishlistData.owner == request.auth.uid;
    }
    
    function hasRole(wishlistData, role) {
      return isSignedIn() && 
             wishlistData.roles != null && 
             wishlistData.roles[request.auth.uid] == role;
    }
    
    function isMember(wishlistData) {
      return isSignedIn() && 
             wishlistData.members != null && 
             request.auth.uid in wishlistData.members;
    }

    // User profiles
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // Wishlists
    match /wishlists/{wishlistId} {
      // Allow any signed-in user to read the wishlist metadata (for the join page)
      // but keep items and sensitive data protected via sub-collection rules
      allow read: if isSignedIn(); 
      
      allow create: if isSignedIn() && request.resource.data.owner == request.auth.uid;
      
      allow update: if isSignedIn() && (
        isOwner(resource.data) || 
        hasRole(resource.data, 'manager') ||
        // Allow owner to update members/roles when approving requests
        (isOwner(resource.data) && request.resource.data.diff(resource.data).affectedKeys().hasAny(['members', 'roles']))
      );
      
      allow delete: if isOwner(resource.data);

      // Items sub-collection
      match /items/{itemId} {
        // Only members can see items
        allow read: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data);
        
        // Only managers/owners can create items
        allow create: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) && 
                      (isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) || 
                       hasRole(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data, 'manager'));
        
        // Members can update 'claimed' status, managers/owners can update everything
        allow update: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) && (
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['claimed', 'claimedBy', 'claimedAt'])) ||
          (isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) || 
           hasRole(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data, 'manager'))
        );
        
        allow delete: if isMember(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) && 
                      (isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data) || 
                       hasRole(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data, 'manager'));
      }

      // Join requests sub-collection
      match /requests/{requestId} {
        allow read: if isSignedIn() && (
          request.auth.uid == resource.data.uid || 
          isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data)
        );
        allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
        allow update: if isSignedIn() && isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data);
        allow delete: if isSignedIn() && (
          request.auth.uid == resource.data.uid || 
          isOwner(get(/databases/$(database)/documents/wishlists/$(wishlistId)).data)
        );
      }
    }
    
    // Groups (Future implementation)
    match /groups/{groupId} {
      allow read: if isSignedIn() && request.auth.uid in resource.data.members;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.owner == request.auth.uid;
    }
  }
}